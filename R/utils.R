#' Generate an encoding key which is used for encoding and decoding strings to pass the R parser
#'
#' @return A list containing the encoding key, with 'input' specifying the characters to be encoded
#' and 'output' specifying their corresponding encoded values.
#' @noRd
.get_encode_dictionary <- function() {
  encode_list <- list(
    input = c("(", ")", "\"", ",", " ", ":", "!", "&", "|", "'", "[", "]", "=", "+", "-", "*", "/", "^"),
    output = c("$LB$", "$RB$", "$QUOTE$", "$COMMA$", "$SPACE$", "$COLON$", "$EXCL$", "$AND$", "$OR$",
               "$APO$", "$LSQ$", "$RSQ", "$EQU$", "$ADD$", "$SUB$", "$MULT$", "$DIVIDE$", "$POWER$")
  )
  return(encode_list)
}



#' Decode a string using the provided encoding key.
#'
#' @param input_string The encoded string passed through the R parser.
#' @param encode_key The encoding key generated by '.getEncodeKey()'.
#' @return The decoded string.
#' @importFrom stringr str_replace_all fixed
#' @importFrom rlang set_names
#' @noRd
.decode_tidy_eval <- function(input_string, encode_key) {
  encode_vec <- set_names(encode_key$input, encode_key$output)
  output_string <- str_replace_all(input_string, fixed(encode_vec))
  return(output_string)
}

#' Generate a string containing the arguments for a Tidyverse function.
#'
#' @param .data Character describing the data object to be manipulated.
#' @param fun Character describing the Tidyverse function to be executed.
#' @param tidy_select_args The arguments for the Tidyverse function passed through the R parser.
#' @return A string representing the Tidyverse function and its arguments.
#' @importFrom stringr str_detect
#' @noRd
.make_tidyselect_arg <- function(.data, fun, tidy_select_args, other_args) {
  if(is.null(other_args)) {
    tidy_arg_string <- paste0(.data, " %>% dplyr::", fun, "(", tidy_select_args, ")")
  } else {
    tidy_arg_string <- paste0(.data, " %>% dplyr::", fun, "(", tidy_select_args, ", ", other_args, ")")
  }

  return(tidy_arg_string)
}

#' Evaluate an expression and handle errors gracefully.
#'
#' @param string_as_expr An expression to be evaluated.
#' @param .data The data environment in which the expression should be evaluated.
#' @importFrom cli cli_abort
#' @return The result of evaluating the expression, or an error message if evaluation fails.
#' @noRd
.tidy_eval_handle_errors <- function(fun, string_as_expr, .data) {
  object_out <- tryCatch(
    eval_tidy(string_as_expr),
    error = function(e) {
      cli_abort(
        c("x" = "`{fun}DS` returned the following error:", "i" = conditionMessage(e)),
        call = NULL
      )
    }
  )

  return(object_out)
}

.permitted_tidy_fun <- function() {
  permitted <- c("select", "rename", "mutate")
  return(permitted)
}

#' Execute a Tidyverse function on a data object with specified arguments.
#'
#' @param .data Character describing the data object to be manipulated.
#' @param fun Character describing the Tidyverse function to be executed.
#' @param tidy_select_args The arguments for the Tidyverse function passed through the R parser.
#' @return The result of executing the Tidyverse function on the data object.
#' @importFrom rlang parse_expr
#' @importFrom rlang eval_tidy
#' @noRd
.execute_tidyverse_function <- function(.data, fun, tidy_select_args, other_args) {
  permitted <- .permitted_tidy_fun()
  if (!fun %in% permitted) {
    cli_abort(
      c("You must only use permitted tidyverse functions within DataSHIELD",
        "i" = "Permitted functions are {permitted}",
        "x" = "You have attempted to pass {fun}"
      ),
      call = NULL
    )
  }
  tidy_string <- .make_tidyselect_arg(.data, fun, tidy_select_args, other_args)
  string_as_expr <- rlang::parse_expr(tidy_string)
  return(.tidy_eval_handle_errors(fun, string_as_expr, .data))
}

#' List Disclosure Settings
#' Outputs a list of disclosure settings
#' @importFrom dplyr %>%
#' @importFrom purrr map
#' @return A named list of disclosure settings.
#' @export
dsListDisclosureSettingsTidyVerse <- function() {
  privacy_options <- .list_privacy_settings()

  out <- privacy_options %>%
    map(.set_privacy_option) %>%
    set_names(privacy_options)

  return(out)
}

#' List Privacy Settings
#' This internal function returns a vector of privacy settings.
#' @return A character vector containing privacy settings.
#' @noRd
.list_privacy_settings <- function() {
  return(
    c(
    "datashield.privacyControlLevel", "nfilter.tab", "nfilter.subset",
    "nfilter.glm", "nfilter.string", "nfilter.stringShort", "nfilter.kNN",
    "nfilter.levels.density", "nfilter.levels.max", "nfilter.noise"
    )
  )
}

#' Set Privacy Option
#' Retrieves the value of a given privacy setting or set a default
#' @param setting The name of the privacy setting.
#' @return The value of the specified privacy setting.
#'
#' @keywords internal
#' @noRd
.set_privacy_option <- function(setting) {
  out <- getOption(setting)
  if (is.null(out)) {
    out <- getOption(paste0("default.", setting))
  }
  return(out)
}

#' List Disclosure Settings
#' Outputs a list of disclosure settings
#' @importFrom dplyr %>%
#' @importFrom purrr map
#' @return A named list of disclosure settings.
#' @export
dsListDisclosureSettingsTidyVerse <- function() {
  privacy_options <- .list_privacy_settings()

  out <- privacy_options %>%
    map(.set_privacy_option) %>%
    set_names(privacy_options)

  return(out)
}

#' List Privacy Settings
#' This internal function returns a vector of privacy settings.
#' @return A character vector containing privacy settings.
#' @noRd
.list_privacy_settings <- function() {
  return(
    c(
    "datashield.privacyControlLevel", "nfilter.tab", "nfilter.subset",
    "nfilter.glm", "nfilter.string", "nfilter.stringShort", "nfilter.kNN",
    "nfilter.levels.density", "nfilter.levels.max", "nfilter.noise"
    )
  )
}

#' Set Privacy Option
#' Retrieves the value of a given privacy setting or set a default
#' @param setting The name of the privacy setting.
#' @return The value of the specified privacy setting.
#'
#' @keywords internal
#'
.set_privacy_option <- function(setting) {
  out <- getOption(setting)
  if (is.null(out)) {
    out <- getOption(paste0("default.", setting))
  }
  return(out)
}

#' Paste Character Arguments
#'
#' This function takes any number of arguments and returns a formatted string
#' that includes the argument names and their corresponding values.
#'
#' @param ... Any number of arguments.
#' @return A character string with the argument names and values.
#' @importFrom purrr map imap set_names
#' @noRd
paste_character_args <- function(...) {
  arg_values <- list(...) %>% purrr::map(deparse)
  call_stack <- sys.call()
  arg_names <- as.character(call_stack)[-1]
  arg_values <- purrr::set_names(arg_values, arg_names)
  args_formatted <- arg_values %>% purrr::imap(~paste0(.y, " = ", .x))
  args_as_vector <- paste(unlist(args_formatted), collapse = ", ")
  return(args_as_vector)
}

#' Check tidyverse disclosure Settings
#'
#' @param df.name A character string specifying the name of the dataframe.
#' @param tidy_select A tidy selection specification of columns.
#' @param datasources A list of Opal connection objects obtained after logging into the Opal servers.
#' @return None. This function is used for its side effects of checking disclosure settings.
#' @noRd
.check_tidy_disclosure <- function(df.name, tidy_select, datasources) {
  disc_settings <- datashield.aggregate(datasources, call("dsListDisclosureSettingsTidyVerse"))
  .check_data_name_length(df.name, disc_settings)
  .check_tidy_disclosure(tidy_select, disc_settings, datasources)
}

#' Check Select Arguments
#'
#' @param .data Character specifying a serverside data frame or tibble.
#' @param newobj Optionally, character specifying name for new server-side data frame.
#' @return This function does not return a value but is used for argument validation.
#'
#' @importFrom assertthat assert_that
#'
#' @noRd
.check_tidy_args <- function(df.name, newobj, .keep) {
  assert_that(!is.null(newobj))
  assert_that(is.character(df.name))
  assert_that(is.character(newobj))
}

